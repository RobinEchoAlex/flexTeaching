```{r context="server"}

assignment_accessible = reactive({
    
  req(input$assignment)

  assignment = input$assignment
  assignment_data = all_assignment_data[[assignment]]
  
  assignment_data$restrict_before<Sys.time()
  
})

```

```{r context="server"}
init_list = reactive({
  
  req(input$assignment)

  assignment = input$assignment
  assignment_data = all_assignment_data[[assignment]]
  
  fmt = flexTeaching::pkg_options()$date_format_prnt
  
  validate(
    need(assignment_accessible(), 
         glue::glue("This assignment will not be available until {strftime(assignment_data$restrict_before, format = fmt)}."))
  )
  
  id = input$id
  seed = seed()
  solutions = solutions()
  
  salt = assignment_data$`data-salt`
  seed0 = flexTeaching:::assignmentSeed(id, seed, salt)
  
  e = new.env()
  
  flexTeaching:::sourceAll(assignment_data, e)
  
  init_func = get(assignment_data$init, envir = e)
  if(!is.null(init_func)){
      R.utils::withSeed({
        ret_list = init_func(assignment_data, id, seed, solutions, e)
      },
      seed0)
  }else{
    ret_list = list()
  }
    
  return(ret_list)
    
}) %>% bindCache(input$assignment, input$id, seed(), solutions(), assignment_accessible())
```


```{r context="render"}
uiOutput("buttonBox", style = "width: 100%; margin: auto;")
```

```{r context="server"}

output$buttonBox <- renderUI({
  
  req(input$assignment)
  
  assignment = input$assignment
  assignment_data = all_assignment_data[[assignment]]
  
  req(assignment_data$restrict_before<Sys.time())
  
  solutions = solutions()
  
  e = new.env()
  flexTeaching:::sourceAll(assignment_data, e)
  
  bn = assignment_data$buttons

  if(is.null(bn)) return()
  
  if(!exists(bn, envir = e)) return()
  bs = get(bn, envir = e)
  
  button_reactives = list()
  
  bl = lapply(names(bs), function(b){
    button_reactives[[b]] = reactive({
      shinybusy::show_modal_spinner(text = "Creating file...")
      fc = bs[[b]]$f(
        assignment_data,
        input$id,
        seed(),
        solutions,
        input$format,
        init_list(),
        entry)
      shinybusy::remove_modal_spinner()
      return(fc)
    }) %>% bindCache(input$assignment, input$id, seed(), solutions(), input$format, b, assignment_accessible())
    
    output[[glue::glue("button_{b}")]] <- downloadHandler(
      filename = function() {
        button_reactives[[b]]()$fn
      },
      content = function(f) {
        d = button_reactives[[b]]()$d
        con = file(description = f, open = "wb")
        writeBin(object = d, con = con)
        close(con)
      }
    )
    
    shiny::downloadButton(glue::glue("button_{b}"), label=bs[[b]]$label,
                          icon = icon(bs[[b]]$icon))
  })
  
  do.call(tagList, bl)
})
```



### Assignment

```{r context="render"}
uiOutput("assignmentBox")
```

```{r context="server"}
render_out <- reactive({
  
  req(input$assignment)
  assignment = input$assignment
  assignment_data = all_assignment_data[[assignment]]
  
  id = input$id
  seed = seed()
  solutions = solutions()
  
  i = init_list()
  
  e = new.env()
  flexTeaching:::sourceAll(assignment_data, e)
  
  html = flexTeaching:::compilePage(assignment_data, id, seed, solutions, e, i)
  
 return(html)
  
}) %>%
  bindCache(input$assignment, input$id, seed(), solutions(), assignment_accessible())
```

```{r context="server"}
output$assignmentBox <- renderUI({
  withMathJax(render_out())
})
```


```{r context="server"}
observeEvent(render_out(), {
  
  req(input$assignment)
  assignment = input$assignment
  assignment_data = all_assignment_data[[assignment]]
  
  req(!is.null(assignment_data[['on-load']]))
  
  js_content = gsub(pattern = "\"", replacement = "\\\"", x = assignment_data[['on-load']],
                    fixed = TRUE)
  
  e = new.env()
  e$.flexteach_info = init_list()
  js_expr = parse(text = glue::glue('glue::glue("{js_content}")'))
  js_parsed = tryCatch(eval(expr = js_expr, envir = e),
    error = function(c) 
      safeError(glue::glue("Problem parsing javascript code on load of assignment {input$assignment}: {c}"))
    )


  if(!is.null(js_parsed) & length(js_parsed)>0)
    shinyjs::runjs(js_parsed)
  
})
```
