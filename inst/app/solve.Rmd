---
title: "Check your assignments"
output: 
  flexdashboard::flex_dashboard:
    theme: yeti
runtime: shiny_prerendered
---

```{r child="children/setup.Rmd"}
```

```{r, context="render"}
library(rclipboard)
shiny::includeScript(path = system.file("lib/clipboard.min.js", package = "rclipboard"))

```


Column {.sidebar}
-----------------------------------------------------------------------

```{r child="children/sidebar_main.Rmd"}
```

```{r child="children/sidebar_solve.Rmd"}
```

Column
------------------------------------

```{r context="render"}
shiny::tags$div(
  uiOutput("dataDownloadBox", style="height:54px; float: left; margin-right: 20px; width: 154px;"),
  uiOutput("pdfDownloadBox", style="height:54px; margin-left:160px"),
  style = "width: 100%; height: 54px; margin: auto;"
)
```


```{r context="server"}
output$dataDownloadBox <- renderUI(
  {
  
    if(is.null(render_out()$data_set)) return()
    
    downloadButton("dataDownload", "Download data")
  }
)

output$dataDownload <- downloadHandler(
  filename = function() {
    ext = flexTeaching:::formats[[input$format]]$ext
    glue::glue(render_out()$fn)
  },
  content = function(file) {
    flexTeaching:::formats[[input$format]]$f(render_out()$data_set, file)
  }
)
```


```{r context="server"}
output$pdfDownloadBox <- renderUI(
  {
    assignment = input$assignment
    if(is.null(assignment)) return()
    assignment_data = all_assignment_data[[assignment]]
    
    if(is.null(assignment_data$`pdf-gen`)) return()
    
    downloadButton("pdfDownload", "Download PDF", icon = shiny::icon("file-export"))
  }
)

output$pdfDownload <- downloadHandler(
  filename = function() {
    time = format(Sys.time(), "%d%m%Y_%H%M%S")
    glue::glue("questions_solve_{input$assignment}_{input$id}_{input$seed}_{time}.pdf")
  },
  content = function(f) {
    con = file(f, open = "wb")
    writeBin(object = pdf_content(), con = con)
    close(con)
  }
)
```


```{r context="server"}
render_out <- reactive({
  
  assignment = input$assignment
  if(is.null(assignment)) return()
  assignment_data = all_assignment_data[[assignment]]
  
  id = input$id
  seed = input$seed
  solutions = input$solutions

  out = flexTeaching:::compileAll(assignment_data, id, seed, solutions, type = "solve")
  
  list(data_set = out$data_set, fn = out$fn, html = out$html)
  
}) %>%
  bindCache(input$assignment, input$id, input$seed, input$solutions)
```

```{r context="server"}
pdf_content <- reactive({
    assignment_data = all_assignment_data[[input$assignment]]
    shinybusy::show_modal_spinner(text = "Creating PDF...")
    out = flexTeaching:::compileAll(assignment_data, input$id, input$seed, input$solutions, pdf = TRUE)
    if(is.null(out)) stop("Could not create PDF file.")
    file_content = readBin(con = out, what = "raw", n = file.size(out))
    shinybusy::remove_modal_spinner()
    return(file_content)
}) %>%
  bindCache(input$assignment, input$id, input$seed, input$solutions)
```

### Assignment

```{r context="render"}
uiOutput("assignmentBox")
```

```{r context="server"}
output$assignmentBox <- renderUI({
  withMathJax(render_out()$html)
})
```


<script>
$(document).ready(function () {
  $("#admin_panel").hide();
  $("#show_admin").on("click", function() {
    $("#admin_panel").toggle();
  });
});
</script>

