---
title: "Check your assignments"
output: 
  flexdashboard::flex_dashboard:
    theme: yeti
    orientation: row
runtime: shiny
---

```{r child="children/setup.Rmd"}
```

```{r}
library(rclipboard)
shiny::includeScript(path = system.file("lib/clipboard.min.js", package = "rclipboard"))

```


Column {.sidebar}
-----------------------------------------------------------------------

```{r child="children/sidebar_main.Rmd"}
```

```{r child="children/sidebar_solve.Rmd"}
```

Row {data-height=60}
------------------------------------

```{r}
render_out <- reactive({
  
  ## Add solutions
  assignment = input$assignment
  id = input$id
  seed = input$seed
  
  if(is.null(assignment)) return()
  
  salt = all_assignment_data[[assignment]]$`data-salt`
  seed = flexTeaching:::assignmentSeed(id, seed, salt)

  e = new.env()
  e$.flexteach_solutions = input$solutions

  src = all_assignment_data[[assignment]]$source
  if(!is.null(src))
    source(file.path(all_assignment_data[[assignment]]$path, src), local = e, chdir = FALSE) 

  compile_assignment = get(all_assignment_data[[assignment]]$`html-gen`, envir = e)

  if(!is.null(all_assignment_data[[assignment]]$`data-gen`)){
    get_data = get(all_assignment_data[[assignment]]$`data-gen`, envir = e)
    R.utils::withSeed({
      get_data(envir = e)
    }, seed)
    
    data_set = e$.flexteach_data
    hash = digest::digest(data_set)
    time = format(Sys.time(), "%d%m%Y_%H%M%S")
    fn = glue::glue("data_solve_{assignment}_{id}_{seed}_{time}_{hash}{{ext}}")
  }else{
    data_set = NULL
    fn = NULL
  }

  R.utils::withSeed({
    res = compile_assignment(all_assignment_data[[assignment]]$path, envir = e)
    seed
  }, seed)

  html = HTML(paste(readLines(res), collapse = "\n"))
  
  list(data_set = data_set, fn = fn, html = html)
  
}) %>%
  bindCache(input$assignment, input$id, input$seed, input$solutions)
```

```{r}
uiOutput("dataDownloadBox", style="height:60px;")
         
output$dataDownloadBox <- renderUI(
  {
  
    if(is.null(render_out()$data_set)) return()
    
    downloadButton("dataDownload", "Download data")
  }
)

output$dataDownload <- downloadHandler(
  filename = function() {
    ext = formats[[input$format]]$ext
    glue::glue(render_out()$fn)
  },
  content = function(file) {
    formats[[input$format]]$f(render_out()$data_set, file)
  }
)
```

Row 
-------------------------------------
    
### Assignment

```{r}
renderUI({
  withMathJax(render_out()$html)
})
```


<script>
$(document).ready(function () {
  $("#admin_panel").hide();
  $("#show_admin").on("click", function() {
    $("#admin_panel").toggle();
  });
});
</script>

