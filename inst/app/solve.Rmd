---
title: "Check your assignments"
output: 
  flexdashboard::flex_dashboard:
    theme: yeti
    orientation: row
runtime: shiny
---

```{r child="children/setup.Rmd"}
```

```{r}
library(rclipboard)
shiny::includeScript(path = system.file("lib/clipboard.min.js", package = "rclipboard"))

```


Column {.sidebar}
-----------------------------------------------------------------------

```{r child="children/sidebar_main.Rmd"}
```

```{r child="children/sidebar_solve.Rmd"}
```

Row {data-height=60}
------------------------------------

```{r}
uiOutput("dataDownloadBox", style="height:60px;")
         
output$dataDownloadBox <- renderUI(
  {
  
    if(is.null(values$data_set)) return()
    
    downloadButton("dataDownload", "Download data")
  }
)

output$dataDownload <- downloadHandler(
  filename = function() {
    assignment = input$assignment
    id = input$id
    seed = input$seed
    time = format(Sys.time(), "%d%m%Y_%H%M%S")
    hash = digest::digest(values$data_set)
    ext = formats[[input$format]]$ext
    glue::glue("data_solve_{assignment}_{id}_{seed}_{time}_{hash}{ext}")
  },
  content = function(file) {
    formats[[input$format]]$f(values$data_set, file)
  }
)
```

Row 
-------------------------------------
    
### Assignment

```{r}
renderUI({
  
  assignment = input$assignment
  
  if(is.null(assignment)) return()
  
  salt = all_assignment_data[[assignment]]$`data-salt`
  seed = flexTeaching:::assignmentSeed(input$id, input$seed, salt)

  e = new.env()

  src = all_assignment_data[[assignment]]$source
  if(!is.null(src))
    source(file.path(all_assignment_data[[assignment]]$path, src), local = e, chdir = FALSE) 

  compile_assignment = get(all_assignment_data[[assignment]]$`html-gen`, envir = e)

  if(!is.null(all_assignment_data[[assignment]]$`data-gen`)){
    get_data = get(all_assignment_data[[assignment]]$`data-gen`, envir = e)
    R.utils::withSeed({
      get_data(envir = e)
    }, seed)
    
    values$data_set = e$.flexteach_data
  }else{
    values$data_set = NULL
  }

  R.utils::withSeed({
    res = compile_assignment(all_assignment_data[[assignment]]$path, envir = e)
    seed
  }, seed)


  
  return(withMathJax(includeHTML(res)))
})
```


<script>
$(document).ready(function () {
  $("#admin_panel").hide();
  $("#show_admin").on("click", function() {
    $("#admin_panel").toggle();
  });
});
</script>

